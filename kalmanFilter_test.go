package kalmanfilter

import (
	"testing"
)

func TestSingleStateKalmanFilter(t *testing.T) {
	dataTest := []float64{20.91534388, 19.16729438, 20.13710148, 19.78019813, 21.38354608, 19.41559158,
		20.82670153, 19.83351734, 19.6899322, 20.30871468, 19.76104254, 19.68844745,
		21.7719712, 20.81477583, 19.60775556, 20.49493325, 20.6319866, 18.89279635,
		18.61049549, 18.9792213, 17.73965033, 19.86126424, 18.27904238, 18.54922838,
		20.29345067, 19.45327316, 20.78006727, 19.5836117, 20.30258762, 20.68212395,
		21.50827259, 19.22479669, 19.22208448, 21.34532192, 20.37180142, 19.57560563,
		19.98389295, 19.85696325, 20.13042875, 20.62698812, 18.44824171, 19.4872442,
		19.07370758, 19.18700227, 20.99883546, 19.84695884, 19.37148291, 22.46810557,
		20.89185341, 20.09988889, 19.10235219, 19.75765235, 19.63009277, 17.65050074,
		21.81006941, 21.31054233, 20.19800647, 19.82205419, 20.40460282, 22.53017836,
		20.91012525, 19.56744802, 19.87735583, 21.74651965, 19.52338097, 19.77278303,
		21.41696653, 19.16572815, 19.47127232, 19.72893224, 21.08216476, 19.64131994,
		19.5246698, 20.92104497, 17.78909919, 19.95303215, 19.36801696, 18.9050285,
		19.43757486, 20.21022455, 20.48161415, 20.18060897, 17.94343903, 19.77660963,
		19.30559062, 20.4204931, 19.05924384, 19.84195053, 19.62740431, 18.67266154,
		20.52259124, 21.50309677, 18.99283095, 20.11174637, 20.28735347, 19.26495648,
		20.89938356, 20.57144998, 20.03568975, 19.28471261, 21.11327698, 21.76450021,
		21.18525642, 21.91203437, 22.19475322, 21.82979632, 21.87465639, 21.64581181,
		22.09847874, 21.74768608, 20.37626795, 21.98353059, 21.91908899, 20.8633276,
		20.68186432, 22.74922119, 21.15864585, 21.97413793, 20.44366027, 20.61502289,
		20.98305033, 21.57231282, 21.12984216, 21.97533853, 21.17898529, 22.55629095,
		20.81571866, 22.26085513, 23.41004689, 23.16400496, 23.56470738, 23.79207902,
		21.9103189, 20.08563827, 21.35325265, 23.26893817, 24.30689974, 23.16859186,
		22.06083389, 22.49827206, 23.54621101, 20.50614036, 21.9210117, 23.86849591,
		22.12435088, 21.42273002, 21.98648143, 22.18616511, 21.10757608, 22.55714846,
		22.25011345, 21.39007576, 22.37953541, 21.39050416, 21.20547677, 21.16889639,
		23.81438107, 22.23539596, 20.84845702, 23.08665295, 23.38784762, 21.99872311,
		21.77769031, 21.80181058, 19.78094888, 22.01469028, 20.58379302, 23.39516867,
		22.92241631, 21.75310019, 20.38234646, 23.97506038, 22.54651424, 22.26010743,
		22.81859256, 21.07342008, 23.33700157, 22.20514719, 22.13874307, 21.75483174,
		22.93543839, 21.11127224, 21.01848553, 24.53172383, 21.65168118, 20.63847809,
		22.107562, 22.04469311, 21.81770423, 23.24444589, 20.8989916, 21.46210567,
		23.63443008, 23.38920665, 22.94833177, 23.38353633, 21.49105109, 23.65382684,
		22.74877462, 22.43898878}

	dataExpected := []float64{19.461307032119702, 19.36248990569929, 19.559506515004102, 19.604954601792798,
		19.914770505164924, 19.838914537566886, 19.972924623310668, 19.955732925105046, 19.92550432366762,
		19.966173105585845, 19.945657488625553, 19.921214086448444, 20.089514972388443, 20.153002969785692,
		20.106820427685356, 20.138768465364826, 20.178376087533863, 20.077330063822377, 19.964163952786162,
		19.889393422350572, 19.72847082115277, 19.73829105013418, 19.631511989154905, 19.55304001892531,
		19.60629838952247, 19.595366989816846, 19.679489924421876, 19.672717212407697, 19.71700956817258,
		19.784610122567308, 19.904931396380857, 19.857594577662635, 19.813477167374717, 19.919581445008994,
		19.950844127139487, 19.92494690582276, 19.929009150219272, 19.924050426851576, 19.93823925459636,
		19.985546558235853, 19.880043054203778, 19.853105125437185, 19.799687894334873, 19.75771932230506,
		19.84269491064259, 19.842986729939597, 19.810728918070733, 19.992476579959447, 20.053971763803784,
		20.057110632396114, 19.991857061673088, 19.97585299696015, 19.9522295299192, 19.794988676230062,
		19.932631602799276, 20.026742366589794, 20.038438627072154, 20.0236620403761, 20.049674252338683,
		20.21904375480979, 20.26622867300738, 20.218520113211397, 20.195228320056845, 20.301133885293268,
		20.248038722727333, 20.215595041807052, 20.297605830306228, 20.2203403979589, 20.169207529826437,
		20.139153881257393, 20.2035240148355, 20.165148236620475, 20.12142988168399, 20.176010303423435,
		20.01308474875613, 20.008985708240182, 19.965235004775646, 19.892868645697497, 19.861791844603538,
		19.885574593259655, 19.926257966530464, 19.943618946382262, 19.80709498235661, 19.80501418292032,
		19.770925728167192, 19.815262275151937, 19.763659921548996, 19.769003673915332, 19.759338769756983,
		19.685167372053915, 19.742325885365766, 19.862507537948037, 19.803147677532426, 19.82421110168451,
		19.855822901968878, 19.815493305497736, 19.889474228672853, 19.93602246749814, 19.94282525396534,
		19.897905810087117, 19.980860891083104, 20.102603059876067, 20.176499474727773, 20.294958251032853,
		20.424628571070063, 20.520538150397556, 20.612963343953563, 20.683460299466553, 20.780042218116982,
		20.84608863389434, 20.814021080783146, 20.893845805890056, 20.963823648839497, 20.95696430401322,
		20.93818739060135, 21.061799263059477, 21.06840951392441, 21.13022988511129, 21.083368169031008,
		21.05140132582425, 21.046736037964674, 21.082609208930528, 21.08583308748431, 21.146546158245627,
		21.148760286677163, 21.2448310960907, 21.2155420866505, 21.286889782275455, 21.431805573342384,
		21.550036599570188, 21.687547670829026, 21.831192162282942, 21.836592946634813, 21.717081781686538,
		21.692248675559227, 21.799865394748497, 21.970982670405395, 22.05272531666198, 22.05327876619063,
		22.08365172062711, 22.18347849835183, 22.068992020685037, 22.05889164480721, 22.182405928171164,
		22.178443389064686, 22.126862279899274, 22.117280604838413, 22.12198230699731, 22.052744153433466,
		22.087172198038257, 22.09829373014385, 22.049954412770955, 22.07244991711426, 22.025903805934995,
		21.969905674664947, 21.915232899264698, 22.04485898896395, 22.057864062963855, 21.975316156363423,
		22.05117029196872, 22.142405013862188, 22.132598025844448, 22.108373849918056, 22.087449417308235,
		21.93001954950526, 21.935798738234126, 21.84351777924857, 21.949425491232557, 22.015836841885022,
		21.997903788889186, 21.887634152016414, 22.030111133823667, 22.06535815476126, 22.078650738984287,
		22.129155363270492, 22.057096300905496, 22.144456053930817, 22.14859851883493, 22.147925836569332,
		22.12109525463414, 22.176678130101955, 22.103959001837307, 22.02987016362117, 22.20063383158515,
		22.16316514603297, 22.05909784678055, 22.062405760700422, 22.061196786233367, 22.044577236264114,
		22.126474101432272, 22.04269245699726, 22.003064588009234, 22.11441320881151, 22.201424054744543,
		22.25240413515481, 22.329609403048057, 22.27237372405491, 22.366664610995013, 22.39274547558745,
		22.395901805786263}

	A := 1
	B := 0
	C := 1
	Q := 0.005
	R := 1
	x := 18
	P := 1

	kalmanFilter := NewSingleStateKalmanFilter[float64](
		float64(A), float64(B),
		float64(C), float64(x),
		float64(P), Q, float64(R),
	)

	for i := 0; i < len(dataTest); i++ {
		kalmanFilter.Step(0, dataTest[i])
		currentState := kalmanFilter.CurrentState()

		if currentState != dataExpected[i] {
			t.Error("wrong value", currentState, dataExpected[i])
			t.FailNow()
		}
	}
}
